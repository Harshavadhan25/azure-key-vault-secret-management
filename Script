"""
Azure Key Vault Integration with Azure Storage
Secure secret retrieval using RBAC and Service Principal
"""

import os
from azure.identity import ClientSecretCredential
from azure.keyvault.secrets import SecretClient
from azure.storage.blob import BlobServiceClient

TENANT_ID = os.getenv("AZURE_TENANT_ID")
CLIENT_ID = os.getenv("AZURE_CLIENT_ID")
CLIENT_SECRET = os.getenv("AZURE_CLIENT_SECRET")

KEY_VAULT_NAME = "CyberKeyVault123"
STORAGE_ACCOUNT_NAME = "cyberstorage123"

KV_URL = f"https://{KEY_VAULT_NAME}.vault.azure.net/"

credential = ClientSecretCredential(
    tenant_id=TENANT_ID,
    client_id=CLIENT_ID,
    client_secret=CLIENT_SECRET
)

secret_client = SecretClient(vault_url=KV_URL, credential=credential)

storage_key = secret_client.get_secret("StorageKey").value
print("[+] Secret retrieved securely from Azure Key Vault")

blob_service_client = BlobServiceClient(
    account_url=f"https://{STORAGE_ACCOUNT_NAME}.blob.core.windows.net",
    credential=storage_key
)

containers = blob_service_client.list_containers()
for container in containers:
    print(f"Container found: {container['name']}")

print("[+] Authenticated to Azure Storage successfully")
